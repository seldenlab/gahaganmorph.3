# Composition & Diversity

This analysis of assemblage diversity is limited to Caddo mortuary contexts at the Mounds Plantation, George C. Davis, and Gahagan Mound sites where Gahagan bifaces were recovered.

## Taxonomic composition

```{r composistion}
library(here)
# read data
data <- read.csv("gahagan-diagnostics.csv")

# table of diagnostics
knitr::kable(data)
```

## Relative abundance

```{r relative.abundance}
# mean number of observations for each type
colMeans(data[3:15])
```

## Alpha diversity

```{r diversity, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
library(vegan)
library(RRPP)

# assemblage size (N)
N <- rowSums(data[3:15])
N ## assemblage sizes range from:

# how many of each type were found?
T <- colSums(data[3:15])
T ## quantity of each type (T) found across contexts

## richness (S) = number of types in assemblage
S <- specnumber(data[3:15])
S

## ubiquity (U) = number of assemblages that contain a particular type
U <- specnumber(data[3:15])
U

# data by percentage
data.pct <- data[3:15]/N*100
## mean percent (Mp) of each type across assemblage
Mp <- colMeans(data.pct)
Mp

## percentage of sites that have each type
Up <- U/length(N)*100
Up
```

```{r plot.alpha.diversity, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# prepare data frame
RS <- rowSums(data[, -(1:2)])
CS <- colSums(data[, -(1:2)])
as.matrix(CS)
gahagan_ct <- data[, -(1:2)]
labels <- paste0(data$context, " (", substr(data$region, 1, 1), ")")
rownames(gahagan_ct) <- labels
gahagan_pct <- gahagan_ct / RS  * 100
gahagan_pct$context <- data$context

# plot figure

```

## Diversity indices

```{r diversity.indices, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# Shannon diversity
H <- diversity(data[3:15])
## high diversity = more types and spread more evenly over types
H

# Simpson index
D1 <- diversity(data[3:15], 
                index = "simpson")
## probability that two artefacts drawn randomly represent different types
D1

# inverse Simpson index
D2 <- diversity(data[3:15], 
                index = "invsimpson")
## effective number of types
D2
```

### Shannon diversity

```{r shannon, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# effective number of types for Shannon diversity index
Hmax <- exp(H)
Hmax

# are data normally distributed?
shapiro.test(H)
hist(H, col='steelblue')

# ANOVA: are there differences in assemblage diversity among the contexts?
context <- data$context
df <- data.frame(a = context, b = H)

# MODEL: H as a function of context
shannon <- lm.rrpp(H ~ context,
                   data = df,
                   print.progress = FALSE,
                   iter = 9999)

# ANOVA: do contexts differ by H?
anova(shannon)
```

### Simpson index

```{r simpson, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# are data normally distributed?
shapiro.test(D1)
hist(D1, col='steelblue')

# ANOVA: are there differences in assemblage diversity among the contexts?
df <- data.frame(a = context, b = D1)

# MODEL: D1 as a function of context
simpson <- lm.rrpp(D1 ~ context,
                   data = df,
                   print.progress = FALSE,
                   iter = 9999)

# ANOVA: do contexts differ by D1?
anova(simpson)
```

### Inverse Simpson index

```{r inv.simpson, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# are data normally distributed?
shapiro.test(D2)
hist(D2, col='steelblue')

# ANOVA: are there differences in assemblage diversity among the contexts?
df <- data.frame(a = context, b = D2)

# MODEL: D2 as a function of context
inv.simpson <- lm.rrpp(D2 ~ context,
                       data = df,
                       print.progress = FALSE,
                       iter = 9999)

# ANOVA: do contexts differ by D2?
anova(inv.simpson)
```

## Evenness

```{r even, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# evenness
## Pielou's J (Shannon diversity index divided by natural log of richness)
J <- H/log(S)
J

## ratio of effective species to richness
E <- Hmax/S
E
```

## Beta diversity

```{r diversity1.1, , out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Caddo burial assemblages that include Gahagan bifaces; 1, 41CE19-F134; 2, 41CE19-F119; 3, 16RR1-BP2; 4, 16RR1-BP3; 5, 16CD12-BP1; 6, 16CD12-BP2; 7, 16CD12-BP5; 8, 16CD12-BP8."}
data2 <- data[3:15]
types.jaccard <- vegdist(data2, method = "jaccard")
plot(
  hclust(types.jaccard),
  hang = -1,
  main = "Assemblages clustered by Jaccard similarity",
  axes = FALSE, ylab = ""
)
```

```{r diversity2, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Caddo burial assemblages that include Gahagan bifaces; 1, 41CE19-F134; 2, 41CE19-F119; 3, 16RR1-BP2; 4, 16RR1-BP3; 5, 16CD12-BP1; 6, 16CD12-BP2; 7, 16CD12-BP5; 8, 16CD12-BP8. The three sites in the lower part of the left quadrat exhibit lower diversity and evenness, and each represents the earliest context at each site to include a Gahagan biface. Those sites in the upper right quadrat have higher diversity and evenness, and occur later than those in the lower left quadrat."}
# summarize assemblage diversity to identify high & low diversity assemblages
library(maptools)
pch <- c(1, 3)[as.factor(data$region)]
plot(H, J, 
     pch = pch)
abline(h = median(J), 
       v = median(H), 
       lty = 2)
pointLabel(H, J, 
           rownames(data), 
           cex = .75)
leg.txt <- c(as.expression(bquote("Northern Behavioral Region")), 
             as.expression(bquote("Southern Behavioral Region")))
legend("bottomright", 
       leg.txt, 
       pch = c(1, 3))
```

```{r diversity3, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# sample size and richness
plot(S~N, 
     ylim = c(0, 12), 
     xlim = c(0, 184), 
     pch = 16)
abline(h = seq(0, 12, by = 2), 
       v = seq(0, 184, by = 50), 
       col = "black", 
       lty = 3)

# logarithmic function
data.log <- lm(S~log(N))
summary(data.log)
deviance(data.log)
xval <- seq(1, 184, by = 1)
lines(xval, 
      predict(data.log,
              data.frame(N = xval)),
      lty = 1)

# power function
data.pow <- lm(log(S)~log(N))
summary(data.pow)
sum((S-exp(fitted(data.pow)))^2)
lines(xval, 
      exp(predict(data.pow,
                  data.frame(N = xval))), 
      lty = 2)
```

```{r diversity4, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Rarefaction curve and confidence limits (dashed lines) for comparison of individual assemblages to the composite. Results demonstrate that diversity in the mortuary assemblages from 41CE19-F119 and 16RR1-BP3 are lower than expected based on the rarefaction curve."}
# rarefaction curve
## how do individual assemblages compare to the composite?
xval <- seq(2, 200, by = 2)
data.rar <- rarefy(T, xval, se = TRUE)
Est <- data.rar[1, ]
Sd <- data.rar[2, ]
rare <- cbind(lower = Est-2*Sd, 
              expected = Est, 
              upper = Est+2*Sd)

plot(S~N, 
     ylim = range(rare), 
     xlim = range(xval), 
     pch = 16)
matlines(xval, rare, 
         type = "l", 
         lty = c(2, 1, 2), 
         col = "black")
```
